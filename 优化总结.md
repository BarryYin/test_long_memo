# 三层架构优化总结

## 📋 优化版本: test_gpt52_2_optimized.py

### 🎯 核心改进

#### 1. **Meta层:从"单一策略"到"多步骤流程"**

**问题诊断**:
- 之前Meta层把"优先级阶梯"理解成"三选一"的单一策略
- 只给出单一指令,如"立即二选一询问"
- 策略写死,不够灵活,不管什么Stage都只做一件事

**解决方案**:
- 将"优先级阶梯"重新定义为**对话流程的步骤序列**
- 策略现在包含完整的多步骤流程:

```
Step 1: 尝试全额还款(永远是第一步)
  - 先问用户能否全额还款
  - 如果用户说"没钱全还",不要立即放弃
  - 追问原因:为什么不能全额?具体差多少?
  - 评估原因真实性(参考history_summary)
  - 探索资金来源:能否向亲友借款?能否用信用卡?
  - 强调全额还款的好处
  ↓
Step 2: 根据用户回答,动态分支
  - 如果用户给出合理原因且确实无法全额:
    * 评估是否符合展期条件
    * 如果符合 → 引导展期(今天完成申请)
    * 如果不符合 → 跳到Step 3
  - 如果用户态度恶劣或重复借口:
    * 提高压力等级
    * 直接进入二元收敛
  ↓
Step 3: 协商部分还款(今天)
  - 问用户今天能还多少
  - 强调必须是"今天",不接受"明天"
  - 金额必须是能力范围内的最大值
  - 同步确认剩余金额的处理方案
  - 确认具体时间点
  ↓
Step 4: 如果连部分都拒绝今天完成
  - 触发合规流程告知
  - 告知后续处理流程
  - 记录拒付行为
```

**策略输出示例**:
```json
{
  "today_kpi": [
    "step1_try_full_payment",
    "step2_explore_reasons_and_sources", 
    "step3_assess_extension_or_partial",
    "step4_confirm_today_action"
  ],
  "allowed_actions": [
    "ask_full_payment",
    "ask_reasons",
    "explore_fund_sources",
    "offer_extension_if_eligible",
    "negotiate_partial_today",
    "confirm_time",
    "process_notice"
  ],
  "params": {
    "conversation_flow": "multi_step",
    "current_step": 1,
    "allow_extension": true
  }
}
```

---

#### 2. **10级渐进式压力策略**

**问题诊断**:
- 之前的压力描述太抽象(如"事实压力"、"信用压力")
- 没有明确不同Stage应该使用哪些具体话术
- 缺少从正向激励到强制措施的渐进式设计

**解决方案**:
- 设计10级具体的、渐进式的压力策略
- 明确每个Stage可以使用哪些压力等级

**10级压力策略**:

**压力等级1-3 (正向激励) - 适用于Stage0-1**:
1. **会员等级提升**: "按时还款会获得良好的信用记录,提升您的会员等级"
2. **额度提升**: "会提升您的贷款额度和笔数,未来借款更方便"
3. **还款折扣**: "今天还款可以获得还款折扣优惠"

**压力等级4-6 (信用与限制警告) - 适用于Stage2**:
4. **信用分影响**: "逾期会影响您的信用分,降低贷款额度"
5. **合作终止**: "后续贷款会很困难,我们可能会停止与您的合作"
6. **黑名单警告**: "可能被拉入黑名单,不只是在我们这里,在其他平台也无法借款"

**压力等级7-8 (第三方介入警告) - 适用于Stage3**:
7. **紧急联系人**: "我们可能需要与您的紧急联系人沟通,让他们协助您还款"
8. **工作单位联系**: "可能需要联系您工作的单位,与您的领导沟通了解您的经济状况"

**压力等级9-10 (强制措施) - 适用于Stage4**:
9. **社交媒体联系**: "我们会在社交媒体上与您沟通,需要让您知道我们可以通过多种渠道找到您"
10. **第三方上门**: "将安排第三方上门进行催收"

**使用规则**:
- Stage0-1: 只使用等级1-3(正向激励)
- Stage2: 可使用等级1-6(正向+信用警告)
- Stage3: 可使用等级4-8(信用+第三方介入警告)
- Stage4: 可使用等级7-10(第三方介入+强制措施)
  * 等级9-10需要 sop_trigger_named_escalation=true 且 approval_id 存在

---

#### 3. **Critic层增强检测**

**新增检测能力**:

1. **死循环检测**: 用户在最近2-3轮重复使用同一个借口
2. **意图跳变检测**: 用户意图突然改变(如从"没钱"变成"想延期")
3. **失约触发检测**: 用户承诺的时间点已过但未履行
4. **阶段不匹配检测**: 用户给出的理由表明当前策略目标无法达成

**新增记忆提取**:

5. **reason_category**: 用户不还款的原因分类
   - unemployment (失业/收入问题)
   - illness (疾病/健康问题)
   - forgot (忘记/疏忽)
   - malicious_delay (恶意拖延/拒不配合)
   - other (其他原因)

6. **ability_score**: 用户的还款能力评估
   - zero (完全无力还款)
   - partial (可以部分还款)
   - full (有能力全额还款)

---

#### 4. **Executor层行为限制**

**三大行为限制**:

1. **禁止外推** (DPD >= 0 时严格执行):
   - 如果用户说"明天还"、"下周还"等跨天承诺
   - 必须立刻反驳并拉回"今天"
   - 使用二选一问法:"今天下午还是今天晚上?"

2. **单点突破** (每轮只问一个主问题):
   - 不要一次问多个问题
   - 先问"为什么",等回答后再问"能还多少",再问"几点"
   - 每条消息最多1个主问题 + 1句极短确认

3. **去机械化** (禁止菜单式交互):
   - 禁止使用:"请回复1表示全额,2表示部分,3表示延期"
   - 改用自然询问:"请问您今天是打算全额还清,还是先还一部分呢?"
   - 语气要像真人客服

---

### 📊 对比示例

#### 优化前的对话流程:
```
机构: 请问您今天能还款吗?(能/不能)
用户: 我没钱全还
机构: 请回复"是"或"否"确认您今天能否还款
用户: 我明天还
机构: 好的,我帮您备注明天还款
```
❌ 问题:
- 只做二元询问,没有尝试全额
- 接受了"明天"的承诺(违反当天闭环)
- 使用机械化的"是/否"问法

#### 优化后的对话流程:
```
机构: 您好,您的贷款今天到期了,请问您今天能全额还清10000元吗?
用户: 我没钱全还
机构: 我理解您的情况。请问是什么原因导致无法全额还款呢?具体差多少?
用户: 我这个月失业了,差5000
机构: 很抱歉听到这个消息。那您能否向亲友借款,或者使用信用卡来补足这5000元呢?按时还款会保护您的信用记录,提升您的会员等级。
用户: 真的借不到
机构: 我明白了。那您今天能还多少呢?我们可以协商部分还款,但必须是今天完成。
用户: 我明天还5000
机构: 很抱歉,我们只能接受今天的还款安排。请问您今天下午还是今天晚上可以处理这5000元?
```
✅ 改进:
- 先尝试全额,再探索原因和资金来源
- 使用正向激励(会员等级提升)
- 拒绝"明天",强制拉回"今天"
- 自然对话,不使用机械化问法

---

### 🚀 使用建议

1. **测试多步骤流程**:
   - 输入"我没钱全还",观察系统是否按Step 1→2→3→4执行
   - 查看右侧策略面板,确认 today_kpi 包含多个步骤

2. **测试压力等级**:
   - 调整DPD参数(0→1→3→7),观察压力话术的变化
   - Stage0-1应该只用正向激励
   - Stage2应该开始警告信用影响
   - Stage3-4应该提及第三方介入

3. **测试行为限制**:
   - 输入"我明天还",看系统是否立刻反驳
   - 观察系统是否每次只问一个问题
   - 检查话术是否自然,不使用菜单式选项

4. **测试增强检测**:
   - 连续2轮说"我没钱",看Critic是否检测到死循环
   - 先说"没钱"再说"想延期",看是否检测到意图跳变
   - 观察右侧面板是否提取了 reason_category 和 ability_score

---

### 📝 技术细节

**文件**: `/Users/mac/Documents/GitHub/longmemo/test_gpt52_2_optimized.py`

**主要修改的函数**:
1. `build_critic_system_prompt()` - 增强检测逻辑
2. `build_meta_system_prompt()` - 多步骤流程设计
3. `build_executor_system_prompt()` - 行为限制和10级压力策略

**运行命令**:
```bash
streamlit run test_gpt52_2_optimized.py
```

**环境要求**:
- 需要设置 `OPENAI_API_KEY` 环境变量
- 模型: gpt-5-mini

---

### ✅ 核心理念

**"少就是多"** - 删除了过度限制,让策略更灵活:
- Meta层不再强制"三选一",而是给出完整的对话流程
- Executor层有明确的行为限制,但在限制内有充分的灵活性
- 压力策略从抽象变为具体,从单一变为渐进式

**"活的策略"** - 策略是动态的、多步骤的:
- 不是写死的单一指令
- 包含多个步骤和分支
- 根据用户回答动态调整

**"渐进式压力"** - 从正向激励到强制措施:
- 10级压力策略,从会员等级提升到第三方上门
- 不同Stage使用不同等级
- 遵守合规,所有压力必须真实可执行

---

# 多步收敛策略系统优化（2025-12-28）

## 📋 问题背景

用户提出两个核心问题：

1. **Memory 更新问题**：后面每轮对话的情况，有没有去补充到 Memory 中？
2. **策略收敛性问题**：第一层给出的策略是否有收敛性，就是有没有给出多步的执行策略，然后让执行层在对话中逼着用户收敛答案，比如用户是否有钱还，大概什么时间还，还多少，全额还是部分，能否展期。

## ✅ 解决方案

### 1. Memory 更新验证

**状态**：✅ 已验证，功能正常

- 代码第 616 行：每轮对话都会调用 `st.session_state.memory.extract_from_dialogue(prompt, st.session_state.messages)`
- 每次用户输入都会实时更新 Memory，包括：
  - 意图判断（LLM）
  - 能力评估（关键词 + LLM）
  - 原因分类
  - 障碍识别
  - **新增：收敛性信息提取（日期、金额、类型、展期）**

### 2. 多步收敛策略系统 🆕

#### 2.1 扩展 Memory 字段

新增 5 个收敛性追踪字段：

```python
# 收敛性追踪字段（多步信息收集）
"has_ability_confirmed": False,      # 是否确认有钱还
"payment_date_confirmed": "",        # 具体还款日期（如 "2025-12-30"）
"payment_amount_confirmed": "",      # 具体金额（如 "2000" 或 "全额"）
"payment_type_confirmed": "",        # "full" / "partial" / ""
"extension_requested": False         # 是否请求展期
```

#### 2.2 智能信息提取

在 `extract_from_dialogue()` 中增加：

**日期识别**：
- "明天" → 自动计算日期（2025-12-29）
- "后天" → 2025-12-31
- "30号" → 2025-12-30
- "2025年12月30日" → 完整日期解析

**金额识别**：
- "全额/全部/所有" → payment_type="full"
- "部分/一部分/先还" → payment_type="partial"
- 数字提取：正则匹配金额数字

**能力确认**：
- "有钱/可以还/能还/会还" → has_ability_confirmed=True
- "没钱/钱不够/没有钱" → has_ability_confirmed=False

**展期请求**：
- "展期/延期/推迟/宽限" → extension_requested=True

#### 2.3 Layer1 策略格式优化

**原格式**（问题）：
```
【今日临时催收策略】
1. 沟通基调：...
2. 重点强调的内容：...
```

**新格式**（解决方案）：
```
【今日临时催收策略】
1. 沟通基调：...
2. 重点强调的内容：...

【多步收敛路径】（核心：逐步收敛关键信息）
Step1: 确认还款能力 - 追问客户当前是否有钱可还（是/否）
Step2: 确认还款时间 - 如果有能力，追问具体哪天还（明确日期）
Step3: 确认还款金额 - 追问能还多少（全额 ¥XXX 还是部分）
Step4: 确认付款方式 - 如果是部分还款，追问剩余如何处理（展期/分期）
Step5: 锁定承诺 - 让客户明确承诺上述信息，记录为正式还款计划

⚠️ 注意：每一步都要等客户明确回答后再进入下一步，不要一次问太多问题。
```

#### 2.4 Layer2 执行逻辑优化

**新增：Multi-Step Convergence 能力**

Layer2 的 System Prompt 现在包含：

```
**YOUR GOAL**: Execute the "TODAY'S STRATEGY" effectively and 
**systematically collect all 5 key information**:
1. 还款能力 (has_ability_confirmed)
2. 还款时间 (payment_date_confirmed)
3. 还款金额 (payment_amount_confirmed)
4. 付款方式 (payment_type_confirmed - full/partial)
5. 展期请求 (extension_requested)

**CONVERGENCE STRATEGY**:
- Check CLIENT CURRENT STATE to see which information is already collected (✅) vs. missing (⏳)
- PRIORITIZE asking about missing information ONE AT A TIME
- Don't overwhelm client - ask 1 question per turn
- If client provides new info, acknowledge it before moving to next question
- Follow the order in "多步收敛路径" from Strategy
```

#### 2.5 UI 可视化改进

**新增：关键信息收敛进度显示**

```
🎯 关键信息收敛进度

✅ 还款能力: full                  ✅ 还款金额: 全额
✅ 还款时间: 2025-12-30            ✅ 付款方式: 全额
✅ 展期请求: 否
```

- ✅ 表示已确认
- ⏳ 表示未确认
- ⚠️ 表示有展期请求（需要注意）

## 🔧 技术实现细节

### 代码修改清单

1. **app_easy.py 第 40-55 行**：扩展 Memory 初始化字段
2. **app_easy.py 第 125-175 行**：增强 `extract_from_dialogue()` 方法
3. **app_easy.py 第 232-268 行**：更新 `get_memory_context()` 输出格式
4. **app_easy.py 第 260-278 行**：Layer1 `generate_initial_strategy()` Prompt 更新
5. **app_easy.py 第 297-304 行**：Layer1 `update_strategy()` Prompt 更新
6. **app_easy.py 第 386-432 行**：Layer2 `execute()` System Prompt 优化
7. **app_easy.py 第 595-630 行**：UI Memory 展示优化

### 核心算法

**日期解析**：
```python
# 相对日期
if "明天" in user_msg:
    tomorrow = (datetime.now() + timedelta(days=1)).strftime('%Y-%m-%d')
    
# 中文日期格式（30号/12月30日）
elif re.search(r'(\d{1,2})[月号日]', user_msg):
    date_match = re.search(r'(\d{1,2})[月号日]', user_msg)
    
# 完整日期格式（2025-12-30 / 2025年12月30日）
elif re.search(r'(\d{4}[-/年]\d{1,2}[-/月]\d{1,2})', user_msg):
```

**金额提取**：
```python
# 数字提取
amount_match = re.search(r'(\d+)', user_msg)
if amount_match:
    self.memory["payment_amount_confirmed"] = amount_match.group(1)
```

## 📊 效果验证

### 测试场景示例

**场景 1：逐步收敛信息**

| 轮次 | 客户输入 | Memory 更新 | Agent 下一步 |
|------|----------|-------------|--------------|
| T1 | "我没钱" | ability_confirmed=False | 追问：什么时候有钱？ |
| T2 | "明天有" | payment_date="2025-12-29" | 追问：能还多少？ |
| T3 | "部分，2000块" | amount="2000", type="partial" | 追问：剩余如何处理？ |
| T4 | "能展期吗" | extension_requested=True | 协商展期条件 |

**场景 2：快速收敛（客户配合）**

| 轮次 | 客户输入 | Memory 更新 | Agent 下一步 |
|------|----------|-------------|--------------|
| T1 | "明天还全额" | date="2025-12-29", type="full", amount="全额" | 锁定承诺，确认转账方式 |

### 预期收益

1. **信息完整性**：从"随机对话"变为"结构化信息收集"
2. **执行效率**：减少无效轮次，平均 3-5 轮完成收敛
3. **可追溯性**：每个关键信息都有明确状态（✅/⏳）
4. **策略智能**：Layer1 知道"还需要问什么"，Layer2 知道"现在该问什么"
5. **用户体验**：避免重复询问，一次只问一个问题

## 🚀 下一步优化方向

### 短期（1-2 周）

1. **收敛性评分**：计算收敛完成度（已确认 / 5 * 100%）
2. **自动终止条件**：5 项全部确认后，自动进入"锁定承诺"阶段
3. **异常检测**：如果连续 5 轮仍未收敛任何信息，触发策略升级

### 中期（1 个月）

4. **LLM 提取增强**：用 LLM 替代正则表达式提取日期/金额（更准确）
5. **多轮对话摘要**：每 3 轮对话生成一次 Memory 摘要，避免信息遗漏
6. **Stage 联动**：收敛度影响 Stage 计算（完全收敛 +1 Stage）

### 长期（2-3 个月）

7. **对话树可视化**：展示收敛路径图（哪些信息已获取）
8. **A/B 测试框架**：对比"有收敛路径" vs "无收敛路径"的回款率
9. **自动报告生成**：每日生成收敛性分析报告（哪些客户信息不全）

---

**修改时间**：2025年12月28日  
**修改人**：GitHub Copilot (Claude Sonnet 4.5)  
**版本**：v2.1 - Multi-Step Convergence Update

