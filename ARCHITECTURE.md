# 三层架构职责划分（修正版）

## 🎯 架构关系图

```
┌─────────────────────────────────────────┐
│         Layer 1: 策略层                  │
│    (Strategy Manager)                   │
│                                         │
│  职责：制定总体催收策略框架              │
│  - 分析客户资料和历史                    │
│  - 制定沟通基调和话术方向                │
│  - 输出【多步收敛路径】(Step1-7)         │
└─────────────────────────────────────────┘
              │
              │ 策略 (Strategy)
              ↓
┌─────────────────────────────────────────┐
│         Layer 2: 执行层                  │
│    (Executor)                           │
│                                         │
│  职责：根据策略生成自然对话              │
│  - 接收 Layer 1 的策略                   │
│  - 查看 Memory 了解已收集的信息          │
│  - 按照【多步收敛路径】执行              │
│  - 生成自然、有压力感的对话              │
└─────────────────────────────────────────┘
              │
              │ 执行结果 (Chat History)
              ↓
┌─────────────────────────────────────────┐
│         Layer 3: 评估层                  │
│    (Evaluator)                          │
│                                         │
│  职责：评估效果 + 分析收敛进度           │
│  - 评估回款可能性 (HIGH/MEDIUM/LOW)      │
│  - 分析信息收敛进度 (5个关键信息)        │
│  - 评估收敛效率 (速度快/慢)              │
│  - 给 Layer 1 提供优化建议               │
└─────────────────────────────────────────┘
              │
              │ 如果回款可能性 LOW 或收敛效率低
              │ 建议 (Advice)
              ↓
┌─────────────────────────────────────────┐
│         Layer 1: 策略层                  │
│    (重新制定策略)                        │
│                                         │
│  - 根据 Layer 3 的建议调整策略           │
│  - 调整【多步收敛路径】优先级            │
│  - 增加/降低压力等级                     │
└─────────────────────────────────────────┘
```

## 📋 Layer 1: 策略层 (Strategy Manager)

### 职责
- **制定总体策略框架**：根据客户资料、历史记录制定催收策略
- **输出多步收敛路径**：明确 Step1-7 的执行顺序
- **接收 Layer 3 的反馈**：根据评估结果调整策略

### 输入
- 客户资料 (customer_profile)
- 历史记录 (history_logs)
- Layer 3 的评估和建议（策略更新时）

### 输出格式
```
【历史分析】
...

【今日临时催收策略】
1. 沟通基调：...
2. 重点强调的内容：...

【多步收敛路径】
Step1: 确认还款能力 - 追问客户当前是否有钱可还（是/否）
Step2: 确认还款时间 - 如果有能力，追问具体哪天还（明确日期）
Step3: 确认还款金额 - 追问能还多少（全额 ¥XXX 还是部分）
Step4: 确认付款方式 - 如果是部分还款，追问剩余如何处理（展期/分期）
Step5: 锁定承诺 - 让客户明确承诺上述信息，记录为正式还款计划
Step6: 如果客户说不能还钱，要问清楚客户不还钱的原因是什么？
Step7: 如果客户坚持今天不能还钱，开始施加压力...
```

### 关键原则
- **策略层不直接控制 Layer 2**：只提供框架，不具体指令
- **接收 Layer 3 的建议**：根据收敛性分析调整策略优先级

---

## 📋 Layer 2: 执行层 (Executor)

### 职责
- **执行 Layer 1 的策略**：将策略转化为自然对话
- **查看 Memory 状态**：了解哪些信息已收集（✅），哪些未收集（⏳）
- **按收敛路径执行**：根据【多步收敛路径】逐步追问

### 输入
- Layer 1 的策略 (strategy)
- 对话历史 (chat_history)
- 客户记忆状态 (memory_context)
- 用户输入 (user_input)

### 输出格式 (JSON)
```json
{
  "user_analysis": "客户当前态度分析",
  "strategy_check": "引用策略中的具体指导",
  "tactical_plan": "根据 Memory 状态，决定追问哪个未确认信息",
  "response": "自然的中文对话"
}
```

### 执行原则
- **只听 Layer 1**：不接收 Layer 3 的直接指令
- **一次问一个问题**：不要同时问多个信息
- **自然对话**：不要显得像机器人审问
- **压力调节**：根据 Memory 中的 intent 和 payment_refusals 调整语气

### 决策逻辑示例
```
如果 Memory 显示：
  ✅ 还款能力: True
  ⏳ 还款时间: 未确认
  ⏳ 还款金额: 未确认
  
那么根据策略的 Step2，应该追问："那您具体什么时候能还呢？"
```

---

## 📋 Layer 3: 评估层 (Evaluator)

### 职责
- **评估策略有效性**：判断回款可能性 (HIGH/MEDIUM/LOW)
- **分析收敛进度**：检查 5 个关键信息的收集状态
- **评估收敛效率**：判断收集速度是否合理
- **给 Layer 1 提供建议**：建议调整策略方向

### 输入
- 对话历史 (chat_history)
- 客户资料 (customer_profile)
- 当前策略 (current_strategy)
- 客户记忆状态 (memory_context) ⭐ 关键新增

### 输出格式
```
【分析】
客户抗拒点分析...

【回款可能性】LOW

【信息收敛进度】
已收集：能力(有钱)、时间(2025-12-30)
未收集：金额、付款方式、展期请求

【收敛效率评估】
收敛速度慢，3轮对话仅收集到2个信息。原因：客户回避金额问题。

【给 Layer 1 的建议】
建议在策略中增加针对金额问题的压力话术，比如"不确定金额就无法安排还款计划"。
同时调整【多步收敛路径】，优先追问金额信息。
```

### 分析维度

#### 1. 回款可能性 (HIGH/MEDIUM/LOW)
- HIGH：客户配合，多数信息已确认，态度积极
- MEDIUM：客户犹豫，部分信息确认，有阻碍
- LOW：客户抗拒，信息收集困难，态度消极

#### 2. 信息收敛进度
检查 5 个关键字段：
1. `has_ability_confirmed` - 还款能力
2. `payment_date_confirmed` - 还款时间
3. `payment_amount_confirmed` - 还款金额
4. `payment_type_confirmed` - 付款方式
5. `extension_requested` - 展期请求

#### 3. 收敛效率
- 理想速度：每轮对话收集 1 个信息，5 轮完成收敛
- 实际速度：如果 3 轮仅收集 1 个信息，说明效率低

#### 4. 建议方向
- 如果回款可能性 LOW → 建议调整压力等级
- 如果收敛效率低 → 建议调整话术，明确追问
- 如果某信息反复无法收集 → 建议调整【多步收敛路径】优先级

---

## 🔄 工作流程示例

### 场景：客户回避金额问题

**第 1 轮对话**
```
Layer 1: 输出策略（包含 Step1-7）
Layer 2: 根据策略执行，问"您有钱还吗？"
客户: "有钱，明天还"
Memory 更新: ability=True, date="2025-12-29"
```

**第 2 轮对话**
```
Layer 3: 评估
  - 回款可能性: MEDIUM
  - 已收集: 能力、时间
  - 未收集: 金额、方式、展期
  - 效率评估: 正常
  - 建议: 继续按 Step3 追问金额

Layer 1: 不需要更新策略（可能性不是 LOW）
Layer 2: 根据策略 Step3，问"您能还多少呢？全额还是部分？"
客户: "明天再说吧"（回避）
Memory 更新: 金额仍未确认
```

**第 3 轮对话**
```
Layer 3: 评估
  - 回款可能性: LOW（客户回避金额问题）
  - 已收集: 能力、时间
  - 未收集: 金额、方式、展期
  - 效率评估: 慢（3轮仅收集2个信息）
  - 建议: 在策略中增加压力话术，强调"必须明确金额才能安排"

Layer 1: 更新策略！
  - 调整沟通基调为"坚定"
  - 在【多步收敛路径】中增加压力手段
  - 明确"不确定金额无法继续协商"

Layer 2: 根据新策略执行
  问: "XX先生，我们需要明确您能还多少才能安排还款计划。
       如果您一直不明确金额，我们只能按照违约处理..."
```

---

## ✅ 架构优势

### 1. 职责清晰
- Layer 1：战略决策
- Layer 2：战术执行
- Layer 3：效果评估

### 2. 单向依赖
- Layer 2 只听 Layer 1
- Layer 3 只建议 Layer 1
- 不存在交叉指令

### 3. 压力分散
- Layer 2 不需要做复杂的收敛性判断
- 只需要"看 Memory + 执行策略"
- 判断逻辑全部在 Layer 3

### 4. 可扩展性
- Layer 3 可以增加更多分析维度（如情绪分析、风险评估）
- Layer 1 可以引入更复杂的策略库
- Layer 2 保持简单，只负责执行

---

## 🚫 常见错误理解

### ❌ 错误 1：Layer 3 直接指挥 Layer 2
```
Layer 3 输出："下一步应该问时间"
Layer 2 接收："好的，我现在问时间"
```
**问题**：绕过了 Layer 1，破坏了策略框架

### ✅ 正确做法
```
Layer 3 输出："收敛进度慢，建议 Layer 1 调整策略，优先追问时间"
Layer 1 更新策略："【多步收敛路径】Step2 优先执行：追问时间"
Layer 2 执行："按照策略 Step2，我问时间"
```

### ❌ 错误 2：Layer 2 自己判断该问什么
```
Layer 2: "我看 Memory 里缺金额，我自己决定问金额"
```
**问题**：Layer 2 承担了判断职责，与 Layer 3 功能重复

### ✅ 正确做法
```
Layer 2: "策略说 Step3 是问金额，Memory 显示金额未确认，我执行 Step3"
```

---

**文档版本**：v3.0  
**创建时间**：2025-12-28  
**适用版本**：app_easy.py v2.2 (架构修正版)
